# Docker Compose configuration for Symfony Handmade & Plush Shop
# Services: PHP-FPM, Nginx, MySQL, Redis, Mailpit

services:
  # PHP-FPM Application Container
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev  # Use 'production' for production builds
    container_name: symfony_app
    restart: unless-stopped
    working_dir: /var/www/symfony
    volumes:
      - .:/var/www/symfony
      - symfony_var:/var/www/symfony/var
      - symfony_vendor:/var/www/symfony/vendor
    environment:
      # Symfony environment
      APP_ENV: ${APP_ENV:-dev}
      APP_SECRET: ${APP_SECRET:-changeme}
      # Database
      DATABASE_URL: mysql://${MYSQL_USER:-root}:${MYSQL_PASSWORD:-root}@database:3306/${MYSQL_DATABASE:-shop}?serverVersion=8.0
      # Redis
      REDIS_URL: redis://cache:6379
      MESSENGER_TRANSPORT_DSN: doctrine://default
      # Mailer
      #MAILER_DSN: smtp://mailer:1025
    depends_on:
      - database
      - cache
      - mailer
    networks:
      - symfony

  # Nginx Web Server
  web:
    image: nginx:alpine
    container_name: symfony_web
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - .:/var/www/symfony:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - app
    networks:
      - symfony

  # MySQL Database
  database:
    image: mysql:8.0
    container_name: symfony_db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-shop}
      MYSQL_USER: ${MYSQL_USER:-shopuser}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-shoppass}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/my.cnf:/etc/mysql/conf.d/custom.cnf:ro
    command: --default-authentication-plugin=mysql_native_password
    networks:
      - symfony

  # Redis Cache for sessions and Symfony Messenger
  cache:
    image: redis:7-alpine
    container_name: symfony_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - symfony

  # Mailpit for local email testing
  mailer:
    image: axllent/mailpit:latest
    container_name: symfony_mailpit
    restart: unless-stopped
    ports:
      - "1025:1025"  # SMTP port
      - "8025:8025"  # Web UI port
    environment:
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
    networks:
      - symfony

networks:
  symfony:
    driver: bridge

volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  symfony_var:
    driver: local
  symfony_vendor:
    driver: local
  nginx_logs:
    driver: local
