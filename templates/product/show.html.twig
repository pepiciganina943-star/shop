{% extends 'base.html.twig' %}

{# 1. META ДАННИ ЗА FACEBOOK #}
{% block meta_og %}
    <meta property="og:title" content="{{ product.name }} | Bellamie">
    <meta property="og:description" content="{{ product.description|striptags|slice(0, 200) }}...">
    <meta property="og:url" content="{{ app.request.uri }}">
    <meta property="og:type" content="product">
    <meta property="product:price:amount" content="{{ product.price }}">
    <meta property="product:price:currency" content="BGN">

    {% set metaImg = '' %}
    {% if product.coverImage %}
        {% set metaImg = 'http' in product.coverImage.filename ? product.coverImage.filename : absolute_url(asset('uploads/products/' ~ product.coverImage.filename)) %}
    {% elseif product.imageFilename %}
        {% set metaImg = 'http' in product.imageFilename ? product.imageFilename : absolute_url(asset('uploads/products/' ~ product.imageFilename)) %}
    {% else %}
        {% set metaImg = absolute_url(asset('images/placeholder.jpg')) %}
    {% endif %}
    <meta property="og:image" content="{{ metaImg }}">
{% endblock %}

{% block title %}{{ product.name }} - Детайли{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/drift-zoom@1.3.1/dist/drift-basic.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <style>
        .product-details { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 3px 15px rgba(0,0,0,0.1); }
        .price-display { font-size: 2.5rem; color: var(--teal); font-weight: bold; }

        .gallery-container { position: sticky; top: 20px; }
        .main-image-wrapper { width: 100%; height: 500px; background: #f8f9fa; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; border: 2px solid #e9ecef; position: relative; overflow: hidden; }
        .main-image { width: 100%; height: 100%; object-fit: contain; transform-origin: center center; transition: transform 0.1s ease-out; cursor: crosshair; }

        @media (max-width: 768px) { .main-image-wrapper { height: 350px; touch-action: none; } }

        .thumbnails-container { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
        .thumbnail { width: 80px; height: 80px; border-radius: 8px; overflow: hidden; border: 3px solid transparent; cursor: pointer; transition: all 0.3s ease; background: #f8f9fa; }
        .thumbnail:hover, .thumbnail.active { border-color: var(--teal); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .thumbnail img { width: 100%; height: 100%; object-fit: cover; }
        .drift-zoom-pane { background: #fff; border: 3px solid var(--teal); border-radius: 8px; box-shadow: 0 8px 30px rgba(0,0,0,0.3); z-index: 9999; }

        .similar-products-swiper { padding: 20px 0 50px; }
        .swiper-button-next, .swiper-button-prev { color: var(--teal); }
        .swiper-pagination-bullet-active { background: var(--teal); }

        /* --- ВАЖНО: CSS ЗА HOVER ЕФЕКТА --- */
        .image-swap-container {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            background: #fff; /* Бял фон, за да не прозира */
        }
        .image-swap-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: opacity 0.3s ease-in-out;
            background: #fff;
        }
        .image-swap-container .img-front {
            z-index: 2;
            opacity: 1;
        }
        .image-swap-container .img-back {
            z-index: 1;
            opacity: 0;
        }
        /* Магията при ховър */
        .product-card:hover .image-swap-container .img-front {
            opacity: 0;
        }
        .product-card:hover .image-swap-container .img-back {
            opacity: 1;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container mt-4 mb-5">
        {# Логика за главната снимка #}
        {% set initialImg = '' %}
        {% if product.coverImage %}
            {% set initialImg = 'http' in product.coverImage.filename ? product.coverImage.filename : asset('uploads/products/' ~ product.coverImage.filename) %}
        {% elseif product.imageFilename %}
            {% set initialImg = 'http' in product.imageFilename ? product.imageFilename : asset('uploads/products/' ~ product.imageFilename) %}
        {% else %}
            {% set initialImg = asset('images/placeholder.jpg') %}
        {% endif %}

        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ path('app_home') }}">Начало</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
            </ol>
        </nav>

        <div class="row">
            {# ГАЛЕРИЯ #}
            <div class="col-lg-6 mb-4">
                <div class="gallery-container">
                    <div class="main-image-wrapper" id="imageWrapper">
                        <img src="{{ initialImg }}" class="main-image" id="mainImage" data-zoom="{{ initialImg }}" alt="{{ product.name }}">
                    </div>

                    {% if product.images|length > 1 %}
                        <div class="thumbnails-container">
                            {% for image in product.images %}
                                {% set thumbUrl = 'http' in image.filename ? image.filename : asset('uploads/products/' ~ image.filename) %}
                                <div class="thumbnail {% if loop.first %}active{% endif %}" role="button" tabindex="0" aria-label="Виж снимка {{ loop.index }}" data-image="{{ thumbUrl }}" onclick="switchImage(this)">
                                    <img src="{{ thumbUrl }}" alt="">
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            {# ДЕТАЙЛИ #}
            <div class="col-lg-6">
                <div class="product-details">
                    <h1 class="mb-3 fw-bold">{{ product.name }}</h1>
                    <div class="d-flex align-items-center mb-4">
                        <span class="price-display me-3">{{ product.price }} евро.</span>
                        {% if product.stock > 0 %}
                            <span class="badge bg-success rounded-pill px-3 py-2"><i class="fas fa-check"></i> В наличност ({{ product.stock }} бр.)</span>
                        {% else %}
                            <span class="badge bg-danger rounded-pill px-3 py-2"><i class="fas fa-times"></i> Изчерпано</span>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <h2 class="h5 text-muted mb-3">Описание</h2>
                        <div class="description-content text-secondary">{{ product.description|raw }}</div>
                    </div>

                    <div class="mb-4 pt-3 border-top">
                        <p class="small text-muted mb-2">Харесва ли ви? Споделете с приятели:</p>
                        <a href="https://www.facebook.com/sharer/sharer.php?u={{ app.request.uri|url_encode }}" target="_blank" rel="noopener" class="btn btn-outline-primary btn-sm rounded-pill px-3">
                            <i class="fab fa-facebook me-2"></i> Сподели във Facebook
                        </a>
                    </div>

                    <hr class="my-4">
                    <div class="actions">
                        <div class="d-flex gap-2">
                            {% if product.stock > 0 %}
                                <a href="{{ path('app_cart_add', { id: product.id }) }}" class="btn btn-primary btn-lg rounded-pill shadow-sm flex-grow-1">
                                    <i class="fas fa-shopping-cart me-2"></i> Добави
                                </a>
                            {% else %}
                                <button class="btn btn-secondary btn-lg flex-grow-1 rounded-pill" disabled>Изчерпано</button>
                            {% endif %}

                            <button class="btn btn-outline-danger rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 50px; height: 48px;" onclick="toggleWishlist(this, {{ product.id }})" aria-label="Добави в любими">
                                <i class="far fa-heart fa-lg"></i>
                            </button>
                        </div>
                        <a href="{{ path('app_home') }}" class="btn btn-link text-decoration-none mt-3 d-block text-center text-muted">
                            <i class="fas fa-arrow-left me-1"></i> Продължи пазаруването
                        </a>
                    </div>
                </div>
            </div>
        </div>


        {# СЕКЦИЯ ПОДОБНИ ПРОДУКТИ #}
        {% if similarProducts|length > 0 %}
            <div class="container mt-5 pt-5 border-top">
                <h3 class="mb-4 fw-bold">Подобни продукти</h3>
                <div class="swiper similar-products-swiper">
                    <div class="swiper-wrapper">
                        {% for similar in similarProducts %}
                            <div class="swiper-slide">
                                <div class="product-card h-100 shadow-sm border-0 bg-white d-flex flex-column p-2">
                                    <a href="{{ path('app_product_show', {id: similar.id}) }}" style="text-decoration: none; color: inherit;">

                                        {# 1. ОПРЕДЕЛЯНЕ НА ПРЕДНАТА СНИМКА #}
                                        {% set rawFront = '' %}
                                        {% if similar.coverImage %}
                                            {% set rawFront = similar.coverImage.filename %}
                                        {% elseif similar.imageFilename %}
                                            {% set rawFront = similar.imageFilename %}
                                        {% endif %}

                                        {% set frontImg = asset('images/placeholder.jpg') %}
                                        {% if rawFront %}
                                            {% set frontImg = 'http' in rawFront ? rawFront : asset('uploads/products/' ~ rawFront) %}
                                        {% endif %}


                                        {# 2. ОПРЕДЕЛЯНЕ НА ЗАДНАТА СНИМКА (ТЪРСИМ РАЗЛИЧНА) #}
                                        {% set backImg = frontImg %}

                                        {# Проверяваме дали има галерия #}
                                        {% if similar.images|length > 0 %}
                                            {# Циклим през снимките, за да намерим РАЗЛИЧНА от предната #}
                                            {% for img in similar.images %}
                                                {% if backImg == frontImg %} {# Само ако още не сме намерили различна #}
                                                    {% set rawBack = img.filename %}
                                                    {% if rawBack != rawFront %}
                                                        {# Намерихме различна! Задаваме я и спираме #}
                                                        {% set backImg = 'http' in rawBack ? rawBack : asset('uploads/products/' ~ rawBack) %}
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}

                                        {# --- ВИЗУАЛИЗАЦИЯ --- #}
                                        <div class="image-swap-container" style="height: 200px;">
                                            <img src="{{ frontImg }}" class="img-front" alt="{{ similar.name }}">
                                            <img src="{{ backImg }}" class="img-back" alt="{{ similar.name }}">

                                            <div class="hover-overlay">
                                                <span class="badge-view" style="font-size: 12px; padding: 8px 20px;">ВИЖ</span>
                                            </div>
                                        </div>

                                        <div class="p-2 text-center">
                                            <h4 class="h6 fw-bold text-truncate mb-1">{{ similar.name }}</h4>
                                            <div class="text-primary fw-bold small">{{ similar.price }} евро.</div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <div class="swiper-pagination"></div>
                    <div class="swiper-button-next"></div>
                    <div class="swiper-button-prev"></div>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/drift-zoom@1.3.1/dist/Drift.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        // --- DRIFT ZOOM ЛОГИКА ---
        let driftInstance = null;
        const mainImage = document.getElementById('mainImage');
        const imageWrapper = document.getElementById('imageWrapper');

        function initDesktopZoom() {
            if (!mainImage || driftInstance) return;
            if (typeof Drift !== 'undefined') {
                driftInstance = new Drift(mainImage, { paneContainer: imageWrapper, inlinePane: false, zoomFactor: 3, sourceAttribute: 'data-zoom' });
            }
        }

        window.switchImage = function(thumbnail) {
            const newSrc = thumbnail.getAttribute('data-image');
            if (!mainImage) return;

            mainImage.style.opacity = '0.5';

            setTimeout(() => {
                mainImage.src = newSrc;
                mainImage.setAttribute('data-zoom', newSrc);
                mainImage.style.opacity = '1';

                if (driftInstance && typeof driftInstance.setZoomImageURL === 'function') {
                    driftInstance.setZoomImageURL(newSrc);
                }
            }, 150);

            document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
            thumbnail.classList.add('active');
        };

        // --- SWIPER SLIDER НАСТРОЙКИ ---
        document.addEventListener('DOMContentLoaded', function() {
            if (window.matchMedia("(min-width: 769px)").matches) initDesktopZoom();

            new Swiper('.similar-products-swiper', {
                slidesPerView: 1,
                spaceBetween: 20,

                // 1. БЕЗКРАЕН ЦИКЪЛ
                loop: true,

                // 2. АВТОМАТИЧНО ВЪРТЕНЕ
                autoplay: {
                    delay: 3000, // Сменя се на всеки 3 секунди
                    disableOnInteraction: false, // Продължава да се върти дори след като го пипнеш
                    pauseOnMouseEnter: true, // Спира, когато мишката е отгоре (за да може клиентът да разгледа)
                },

                pagination: { el: '.swiper-pagination', clickable: true },
                navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },

                breakpoints: {
                    640: { slidesPerView: 2 },
                    1024: { slidesPerView: 4 }
                }
            });
        });
    </script>
{% endblock %}