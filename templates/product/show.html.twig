{% extends 'base.html.twig' %}

{% block meta_og %}
    {# --- МЕТА ТАГОВЕ ЗА FACEBOOK --- #}
    <meta property="og:title" content="{{ product.name }} | {{ product.price }} евро">
    <meta property="og:type" content="product">
    <meta property="og:description" content="Ръчно изработена красота: {{ product.description|striptags|slice(0, 150) }}...">
    <meta property="og:url" content="{{ app.request.uri }}">
    <meta property="product:price:amount" content="{{ product.price }}">
    <meta property="product:price:currency" content="EUR">
    {% set metaImg = product.coverImage ? ('http' in product.coverImage.filename ? product.coverImage.filename : absolute_url(asset('uploads/products/' ~ product.coverImage.filename))) : absolute_url(asset('images/placeholder.jpg')) %}
    <meta property="og:image" content="{{ metaImg }}">
{% endblock %}

{% block title %}{{ product.name }} - Детайли{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/drift-zoom@1.3.1/dist/drift-basic.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    {# Добавяме FontAwesome за иконата на FB, ако липсва в base #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* Стилове за продукта */
        .product-details { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 3px 15px rgba(0,0,0,0.1); }
        .price-display { font-size: 2.5rem; color: #20c997; font-weight: bold; }
        .gallery-container { position: sticky; top: 20px; }

        .main-image-wrapper {
            width: 100%; height: 500px; background: #f8f9fa; border-radius: 12px; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: center; border: 2px solid #e9ecef; position: relative; overflow: hidden;
        }
        .main-image { width: 100%; height: 100%; object-fit: contain; cursor: zoom-in; }

        @media (max-width: 991px) {
            .main-image-wrapper { height: 350px; }
            .drift-zoom-pane { display: none !important; }
        }

        .thumbnails-container { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
        .thumbnail { width: 80px; height: 80px; border-radius: 8px; overflow: hidden; border: 3px solid transparent; cursor: pointer; transition: all 0.3s ease; background: #f8f9fa; }
        .thumbnail:hover, .thumbnail.active { border-color: #20c997; transform: translateY(-2px); }
        .thumbnail img { width: 100%; height: 100%; object-fit: cover; }

        .drift-zoom-pane { background: #fff; border: 3px solid #20c997; border-radius: 8px; z-index: 9999; }

        /* Стилове за FB бутона */
        .btn-facebook {
            border-color: #1877F2 !important;
            color: #1877F2 !important;
            transition: all 0.3s ease;
        }
        .btn-facebook:hover {
            background-color: #1877F2 !important;
            color: white !important;
        }

        /* --- СТИЛОВЕ ЗА МОДАЛНАТА ГАЛЕРИЯ --- */
        .modal-fullscreen-img .modal-content { background-color: rgba(0,0,0,0.95); height: 100%; border: none; }
        .modal-fullscreen-img .modal-body { padding: 0; height: 100%; display: flex; }
        .modal-swiper { width: 100%; height: 100%; }
        .modal-swiper .swiper-slide { display: flex; justify-content: center; align-items: center; }
        .modal-swiper img { max-width: 100%; max-height: 100vh; object-fit: contain; }
        .modal-nav-btn { color: white !important; background-color: rgba(255, 255, 255, 0.2); width: 50px; height: 50px; border-radius: 50%; }
        .btn-close-white { position: absolute; top: 20px; right: 20px; z-index: 1055; filter: invert(1); }
        .similar-products-swiper { padding: 20px 5px 50px; }
    </style>
{% endblock %}

{% block body %}
    <div class="container mt-4 mb-5">
        {% macro optimize(url, type='large') %}
            {% if 'cloudinary.com' in url %}
                {% if type == 'thumb' %}
                    {{ url|replace({'/upload/': '/upload/w_300,h_300,c_fill,q_auto:eco,f_auto,dpr_auto/'}) }}
                {% else %}
                    {{ url|replace({'/upload/': '/upload/w_1000,h_1000,c_limit,q_auto:eco,f_auto,dpr_auto/'}) }}
                {% endif %}
            {% else %}
                {{ url }}
            {% endif %}
        {% endmacro %}
        {% import _self as imgHelper %}

        {# --- СЪБИРАНЕ НА СНИМКИ --- #}
        {% set galleryImages = [] %}
        {% if product.coverImage %}
            {% set coverUrl = 'http' in product.coverImage.filename ? product.coverImage.filename : asset('uploads/products/' ~ product.coverImage.filename) %}
            {% set galleryImages = galleryImages|merge([coverUrl]) %}
        {% elseif product.imageFilename %}
            {% set coverUrl = 'http' in product.imageFilename ? product.imageFilename : asset('uploads/products/' ~ product.imageFilename) %}
            {% set galleryImages = galleryImages|merge([coverUrl]) %}
        {% else %}
            {% set galleryImages = galleryImages|merge([asset('images/placeholder.jpg')]) %}
        {% endif %}
        {% for image in product.images %}
            {% set imgUrl = 'http' in image.filename ? image.filename : asset('uploads/products/' ~ image.filename) %}
            {% if imgUrl != galleryImages[0] %}
                {% set galleryImages = galleryImages|merge([imgUrl]) %}
            {% endif %}
        {% endfor %}

        {% set initialImg = imgHelper.optimize(galleryImages[0], 'large') %}

        <div class="row">
            {# ГАЛЕРИЯ #}
            <div class="col-lg-6 mb-4">
                <div class="gallery-container">
                    <div class="main-image-wrapper" id="imageWrapper">
                        <img src="{{ initialImg }}" class="main-image" id="mainImage" data-zoom="{{ initialImg }}" alt="{{ product.name }}" onclick="handleImageClick(0)">
                    </div>
                    {% if galleryImages|length > 1 %}
                        <div class="thumbnails-container">
                            {% for imgUrl in galleryImages %}
                                {% set thumbUrl = imgHelper.optimize(imgUrl, 'thumb') %}
                                {% set bigUrl = imgHelper.optimize(imgUrl, 'large') %}
                                <div class="thumbnail {% if loop.first %}active{% endif %}" role="button" data-image="{{ bigUrl }}" onclick="switchImage(this, {{ loop.index0 }})">
                                    <img src="{{ thumbUrl }}" loading="lazy">
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            {# ДЕТАЙЛИ #}
            <div class="col-lg-6">
                <div class="product-details">
                    <h1 class="mb-3 fw-bold">{{ product.name }}</h1>
                    <div class="d-flex align-items-center mb-4">
                        <span class="price-display me-3">{{ product.price }} евро.</span>
                        {% if product.stock > 0 %}
                            <span class="badge bg-success rounded-pill px-3 py-2">В наличност ({{ product.stock }} бр.)</span>
                        {% else %}
                            <span class="badge bg-danger rounded-pill px-3 py-2">Изчерпано</span>
                        {% endif %}
                    </div>
                    <div class="mb-4">{{ product.description|raw }}</div>

                    <div class="actions mt-4">
                        <div class="d-flex gap-2">
                            {% if product.stock > 0 %}
                                <a href="{{ path('app_cart_add', { id: product.id }) }}" class="btn btn-primary btn-lg rounded-pill flex-grow-1">Добави</a>
                            {% else %}
                                <button class="btn btn-secondary btn-lg flex-grow-1 rounded-pill" disabled>Изчерпано</button>
                            {% endif %}

                            {# --- НОВИЯТ FACEBOOK SHARE БУТОН --- #}
                            <a href="https://www.facebook.com/sharer/sharer.php?u={{ app.request.uri|url_encode }}"
                               target="_blank"
                               class="btn btn-outline-primary btn-lg rounded-pill flex-grow-1 btn-facebook d-flex align-items-center justify-content-center">
                                <i class="fab fa-facebook-f me-2"></i> Сподели
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# --- ПОДОБНИ ПРОДУКТИ --- #}
        {% if similarProducts|length > 0 %}
            <div class="container mt-5 pt-5 border-top">
                <h3 class="mb-4 fw-bold">Подобни продукти</h3>
                <div class="swiper similar-products-swiper">
                    <div class="swiper-wrapper">
                        {% for similar in similarProducts %}
                            <div class="swiper-slide">
                                <div class="product-card h-100 shadow-sm border-0 bg-white p-2 text-center">
                                    <a href="{{ path('app_product_show', {id: similar.id}) }}" class="text-decoration-none text-dark">
                                        {% set sImg = similar.coverImage ? ('http' in similar.coverImage.filename ? similar.coverImage.filename : asset('uploads/products/' ~ similar.coverImage.filename)) : asset('images/placeholder.jpg') %}
                                        <img src="{{ imgHelper.optimize(sImg, 'thumb') }}" class="img-fluid rounded mb-2" style="height: 200px; object-fit: cover;">
                                        <h6 class="fw-bold">{{ similar.name }}</h6>
                                        <div class="text-success fw-bold">{{ similar.price }} евро</div>
                                    </a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    {# МОДАЛ ГАЛЕРИЯ #}
    <div class="modal fade modal-fullscreen-img" id="imageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                <div class="modal-body">
                    <div class="swiper modal-swiper">
                        <div class="swiper-wrapper">
                            {% for imgUrl in galleryImages %}
                                <div class="swiper-slide">
                                    <div class="swiper-zoom-container">
                                        <img src="{{ imgHelper.optimize(imgUrl, 'large') }}" loading="lazy">
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="swiper-button-next modal-nav-btn"></div>
                        <div class="swiper-button-prev modal-nav-btn"></div>
                        <div class="swiper-pagination"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/drift-zoom@1.3.1/dist/Drift.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        let driftInstance = null;
        const mainImage = document.getElementById('mainImage');
        const modalElement = document.getElementById('imageModal');
        let bsModal = null;
        let modalSwiper = null;

        window.handleImageClick = function(index) {
            if (window.innerWidth < 992) {
                if (!bsModal && modalElement) bsModal = new bootstrap.Modal(modalElement);
                if (bsModal) {
                    bsModal.show();
                    setTimeout(() => {
                        if (modalSwiper) {
                            modalSwiper.update();
                            modalSwiper.slideToLoop(index, 0);
                        }
                    }, 200);
                }
            }
        };

        window.switchImage = function(thumbnail, index) {
            const newSrc = thumbnail.getAttribute('data-image');
            if (!mainImage) return;
            mainImage.src = newSrc;
            mainImage.setAttribute('onclick', `handleImageClick(${index})`);
            if (driftInstance) driftInstance.setZoomImageURL(newSrc);
            document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
            thumbnail.classList.add('active');
        };

        document.addEventListener('DOMContentLoaded', function() {
            if (mainImage && window.innerWidth >= 992) {
                driftInstance = new Drift(mainImage, {
                    paneContainer: document.getElementById('imageWrapper'),
                    inlinePane: false,
                    zoomFactor: 3,
                    hoverBoundingBox: true
                });
            }

            if (document.querySelector('.modal-swiper')) {
                modalSwiper = new Swiper('.modal-swiper', {
                    observer: true, observeParents: true,
                    loop: true, zoom: true,
                    navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
                    pagination: { el: '.swiper-pagination', clickable: true, type: 'fraction' }
                });
            }

            if (modalElement) {
                modalElement.addEventListener('click', function(e) {
                    if (e.target.tagName !== 'IMG' && !e.target.closest('.modal-nav-btn')) {
                        if (bsModal) bsModal.hide();
                    }
                });
            }

            const slides = document.querySelectorAll('.similar-products-swiper .swiper-slide');
            if (slides.length > 0) {
                new Swiper('.similar-products-swiper', {
                    slidesPerView: 2, spaceBetween: 15,
                    loop: slides.length > 4,
                    breakpoints: { 768: { slidesPerView: 3 }, 1024: { slidesPerView: 4 } }
                });
            }
        });
    </script>
{% endblock %}
